#!/bin/bash

# ä¸‡äº‹å±‹ - Ubuntu æœåŠ¡å™¨å¿«é€Ÿéƒ¨ç½²è„šæœ¬
# æ”¯æŒ Ubuntu 24.04.2 LTS

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ‰“å°å¸¦é¢œè‰²çš„æ¶ˆæ¯
print_message() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_step() {
    echo -e "${BLUE}[STEP]${NC} $1"
}

# æ£€æŸ¥æ˜¯å¦ä¸ºrootç”¨æˆ·
check_root() {
    if [[ $EUID -eq 0 ]]; then
        print_error "è¯·ä¸è¦ä½¿ç”¨rootç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬"
        exit 1
    fi
}

# æ£€æŸ¥Ubuntuç‰ˆæœ¬
check_ubuntu() {
    if ! grep -q "Ubuntu" /etc/os-release; then
        print_error "æ­¤è„šæœ¬ä»…æ”¯æŒUbuntuç³»ç»Ÿ"
        exit 1
    fi
    
    VERSION=$(grep VERSION_ID /etc/os-release | cut -d'"' -f2)
    print_message "æ£€æµ‹åˆ°Ubuntuç‰ˆæœ¬: $VERSION"
}

# æ›´æ–°ç³»ç»Ÿ
update_system() {
    print_step "æ›´æ–°ç³»ç»ŸåŒ…..."
    sudo apt update && sudo apt upgrade -y
}

# å®‰è£…Node.js 18+
install_nodejs() {
    print_step "å®‰è£…Node.js 18..."
    
    # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…Node.js
    if command -v node > /dev/null 2>&1; then
        NODE_VERSION=$(node --version)
        print_message "Node.jså·²å®‰è£…: $NODE_VERSION"
        
        # æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦ >= 18
        MAJOR_VERSION=$(echo $NODE_VERSION | cut -d'.' -f1 | sed 's/v//')
        if [ "$MAJOR_VERSION" -ge 18 ]; then
            print_message "Node.jsç‰ˆæœ¬æ»¡è¶³è¦æ±‚"
            return
        else
            print_warning "Node.jsç‰ˆæœ¬è¿‡ä½ï¼Œéœ€è¦å‡çº§åˆ°18+"
        fi
    fi
    
    # å®‰è£…Node.js 18
    curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
    sudo apt-get install -y nodejs
    
    print_message "Node.jså®‰è£…å®Œæˆ: $(node --version)"
    print_message "npmç‰ˆæœ¬: $(npm --version)"
}

# å®‰è£…Nginx
install_nginx() {
    print_step "å®‰è£…Nginx..."
    
    if command -v nginx > /dev/null 2>&1; then
        print_message "Nginxå·²å®‰è£…"
        return
    fi
    
    sudo apt install -y nginx
    sudo systemctl enable nginx
    sudo systemctl start nginx
    
    print_message "Nginxå®‰è£…å¹¶å¯åŠ¨å®Œæˆ"
}

# å®‰è£…PM2
install_pm2() {
    print_step "å®‰è£…PM2è¿›ç¨‹ç®¡ç†å™¨..."
    
    if command -v pm2 > /dev/null 2>&1; then
        print_message "PM2å·²å®‰è£…"
        return
    fi
    
    sudo npm install -g pm2
    print_message "PM2å®‰è£…å®Œæˆ"
}

# æ„å»ºé¡¹ç›®
build_project() {
    print_step "æ„å»ºé¡¹ç›®..."
    
    # æ£€æŸ¥package.jsonæ˜¯å¦å­˜åœ¨
    if [ ! -f "package.json" ]; then
        print_error "æœªæ‰¾åˆ°package.jsonæ–‡ä»¶ï¼Œè¯·ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œæ­¤è„šæœ¬"
        exit 1
    fi
    
    # å®‰è£…ä¾èµ–
    print_message "å®‰è£…é¡¹ç›®ä¾èµ–..."
    npm ci
    
    # æ„å»ºé¡¹ç›®
    print_message "æ„å»ºç”Ÿäº§ç‰ˆæœ¬..."
    npm run build
    
    print_message "é¡¹ç›®æ„å»ºå®Œæˆ"
}

# é…ç½®PM2
configure_pm2() {
    print_step "é…ç½®PM2..."
    
    # åˆ›å»ºPM2é…ç½®æ–‡ä»¶
    cat > ecosystem.config.js << EOF
module.exports = {
  apps: [{
    name: 'professional-toolkit',
    script: 'npm',
    args: 'start',
    cwd: '$(pwd)',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    instances: 1,
    exec_mode: 'fork',
    watch: false,
    max_memory_restart: '1G',
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true
  }]
};
EOF

    # åˆ›å»ºæ—¥å¿—ç›®å½•
    mkdir -p logs
    
    # å¯åŠ¨åº”ç”¨
    pm2 start ecosystem.config.js
    pm2 save
    pm2 startup
    
    print_message "PM2é…ç½®å®Œæˆï¼Œåº”ç”¨å·²å¯åŠ¨"
}

# é…ç½®Nginx
configure_nginx() {
    print_step "é…ç½®Nginx..."
    
    # è¯»å–åŸŸå
    read -p "è¯·è¾“å…¥æ‚¨çš„åŸŸåï¼ˆå¦‚ï¼šexample.comï¼Œæˆ–ç›´æ¥å›è½¦ä½¿ç”¨localhostï¼‰: " DOMAIN
    DOMAIN=${DOMAIN:-localhost}
    
    # åˆ›å»ºNginxé…ç½®
    sudo tee /etc/nginx/sites-available/professional-toolkit > /dev/null << EOF
server {
    listen 80;
    server_name $DOMAIN;
    
    # Gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
        
        # å®¢æˆ·ç«¯æœ€å¤§è¯·æ±‚ä½“å¤§å°
        client_max_body_size 100M;
    }
    
    # é™æ€æ–‡ä»¶ç¼“å­˜
    location /_next/static/ {
        proxy_pass http://localhost:3000;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }
    
    # å›¾æ ‡ç¼“å­˜
    location ~* \.(ico|png|jpg|jpeg|gif|svg)$ {
        proxy_pass http://localhost:3000;
        add_header Cache-Control "public, max-age=86400";
    }
}
EOF

    # å¯ç”¨ç«™ç‚¹
    sudo ln -sf /etc/nginx/sites-available/professional-toolkit /etc/nginx/sites-enabled/
    
    # åˆ é™¤é»˜è®¤ç«™ç‚¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    sudo rm -f /etc/nginx/sites-enabled/default
    
    # æµ‹è¯•Nginxé…ç½®
    sudo nginx -t
    
    # é‡è½½Nginx
    sudo systemctl reload nginx
    
    print_message "Nginxé…ç½®å®Œæˆ"
}

# é…ç½®é˜²ç«å¢™
configure_firewall() {
    print_step "é…ç½®é˜²ç«å¢™..."
    
    # æ£€æŸ¥ufwæ˜¯å¦å®‰è£…
    if command -v ufw > /dev/null 2>&1; then
        sudo ufw allow 22      # SSH
        sudo ufw allow 80      # HTTP
        sudo ufw allow 443     # HTTPS (ä¸ºå°†æ¥å‡†å¤‡)
        sudo ufw --force enable
        print_message "é˜²ç«å¢™é…ç½®å®Œæˆ"
    else
        print_warning "æœªæ£€æµ‹åˆ°ufwï¼Œè¯·æ‰‹åŠ¨é…ç½®é˜²ç«å¢™å¼€æ”¾80å’Œ443ç«¯å£"
    fi
}

# æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
show_deployment_info() {
    print_step "éƒ¨ç½²å®Œæˆï¼"
    echo
    print_message "åº”ç”¨ä¿¡æ¯ï¼š"
    echo "  â€¢ åº”ç”¨åç§°: ä¸‡äº‹å±‹ - Professional Toolkit"
    echo "  â€¢ è¿è¡Œç«¯å£: 3000 (å†…éƒ¨)"
    echo "  â€¢ å¤–éƒ¨è®¿é—®: http://$DOMAIN"
    echo "  â€¢ è¿›ç¨‹ç®¡ç†: PM2"
    echo "  â€¢ åå‘ä»£ç†: Nginx"
    echo
    print_message "ç®¡ç†å‘½ä»¤ï¼š"
    echo "  â€¢ æŸ¥çœ‹åº”ç”¨çŠ¶æ€: pm2 status"
    echo "  â€¢ æŸ¥çœ‹åº”ç”¨æ—¥å¿—: pm2 logs professional-toolkit"
    echo "  â€¢ é‡å¯åº”ç”¨: pm2 restart professional-toolkit"
    echo "  â€¢ åœæ­¢åº”ç”¨: pm2 stop professional-toolkit"
    echo "  â€¢ é‡å¯Nginx: sudo systemctl restart nginx"
    echo
    print_message "æ—¥å¿—æ–‡ä»¶ä½ç½®ï¼š"
    echo "  â€¢ åº”ç”¨æ—¥å¿—: $(pwd)/logs/"
    echo "  â€¢ Nginxæ—¥å¿—: /var/log/nginx/"
    echo
    print_message "å¦‚éœ€é…ç½®HTTPSï¼Œè¯·ä½¿ç”¨Certbotå®‰è£…SSLè¯ä¹¦"
}

# ä¸»å‡½æ•°
main() {
    print_message "ğŸš€ å¼€å§‹éƒ¨ç½²ä¸‡äº‹å±‹åˆ°UbuntuæœåŠ¡å™¨..."
    echo
    
    check_root
    check_ubuntu
    update_system
    install_nodejs
    install_nginx
    install_pm2
    build_project
    configure_pm2
    configure_nginx
    configure_firewall
    show_deployment_info
    
    echo
    print_message "ğŸ‰ éƒ¨ç½²å®Œæˆï¼äº«å—æ‚¨çš„ä¸‡äº‹å±‹å§ï¼"
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
